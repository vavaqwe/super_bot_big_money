# üîß –ó–í–Ü–¢ –ü–†–û –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø PnL –†–û–ó–†–ê–•–£–ù–ö–£

## üìã –ü–†–û–ë–õ–ï–ú–ê

**–°–∏–º–ø—Ç–æ–º–∏:**
- –£ –ª–æ–≥–∞—Ö –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –ø–æ–∫–∞–∑—É–≤–∞–≤—Å—è PnL = 0.00%:
  ```
  2025-11-14 16:35:17,856 - INFO - üìä [AVA/USDT:USDT] PnL CHECK: +0.00% | TP=10.0% | SL=-10.0%
  ```
- –£ Telegram –ø—Ä–∏ –ø–µ—Ä–µ–≥–ª—è–¥—ñ –ø–æ–∑–∏—Ü—ñ–π PnL –≤—ñ–¥–æ–±—Ä–∞–∂–∞–≤—Å—è –∫–æ—Ä–µ–∫—Ç–Ω–æ:
  ```
  üìà AVA
  üî¥ SHORT | üíµ 100.0000 –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ñ–≤
  üí∞ –†–æ–∑–º—ñ—Ä: $34.92 USDT
  ‚ù§Ô∏è PnL: $-1.05 (-3.02%)
  ```
- –ß–µ—Ä–µ–∑ —Ü–µ –Ω–µ —Å–ø—Ä–∞—Ü—å–æ–≤—É–≤–∞–ª–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞–∫—Ä–∏—Ç—Ç—è –ø–æ–∑–∏—Ü—ñ–π –ø–æ Stop Loss

## üîç –ü–†–ò–ß–ò–ù–ê –ü–†–û–ë–õ–ï–ú–ò

–£ —Ñ—É–Ω–∫—Ü—ñ—ó –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –ø–æ–∑–∏—Ü—ñ–π (`monitor_positions()` –≤ `bot.py`):

1. **–û—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ—ó —Ü—ñ–Ω–∏** –≤—ñ–¥–±—É–≤–∞–ª–æ—Å—è –Ω–∞ —Ä—è–¥–∫–∞—Ö 759-766:
   ```python
   current_price = None
   if exchange == "gate":
       ticker = fetch_xt_ticker(xt, symbol)
       current_price = float(ticker['last']) if ticker else None
   elif exchange == "xt" and xt:
       ticker = xt_client.fetch_xt_ticker(xt, symbol)
       current_price = float(ticker['last']) if ticker else None
   ```

2. **–ü—Ä–æ–±–ª–µ–º–∞:** —Ü—è —Ü—ñ–Ω–∞ –∑–±–µ—Ä—ñ–≥–∞–ª–∞—Å—è —Ç—ñ–ª—å–∫–∏ –≤ –ª–æ–∫–∞–ª—å–Ω—ñ–π –∑–º—ñ–Ω–Ω—ñ–π `current_price`, –∞–ª–µ **–ù–ï –¥–æ–¥–∞–≤–∞–ª–∞—Å—è –¥–æ —Å–ª–æ–≤–Ω–∏–∫–∞ `position`**

3. **–ù–∞—Å–ª—ñ–¥–æ–∫:** –∫–æ–ª–∏ –≤–∏–∫–ª–∏–∫–∞–ª–∞—Å—è —Ñ—É–Ω–∫—Ü—ñ—è `calculate_pnl_percentage(position)` –Ω–∞ —Ä—è–¥–∫—É 772, –≤–æ–Ω–∞ –Ω–µ –º–æ–≥–ª–∞ –∑–Ω–∞–π—Ç–∏ –ø–æ—Ç–æ—á–Ω—É —Ü—ñ–Ω—É —É —Å–ª–æ–≤–Ω–∏–∫—É `position`:
   ```python
   current_price = float(
       position.get('markPrice') or 
       position.get('currentPrice') or 
       position.get('current_price') or 0
   )  # –ü–æ–≤–µ—Ä—Ç–∞–ª–æ 0!
   ```

4. –ß–µ—Ä–µ–∑ `current_price = 0` —Ñ—É–Ω–∫—Ü—ñ—è –ø–æ–≤–µ—Ä—Ç–∞–ª–∞ `PnL = 0.0%`

## ‚úÖ –†–Ü–®–ï–ù–ù–Ø

**–ó–º—ñ–Ω–∏ –≤ —Ñ–∞–π–ª—ñ `/app/bot.py`:**

### –ó–º—ñ–Ω–∞ 1: –ü–µ—Ä–µ–Ω–µ—Å–µ–Ω–Ω—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ü—ñ–Ω–∏ –Ω–∞ –ø–æ—á–∞—Ç–æ–∫ —Ü–∏–∫–ª—É (—Ä—è–¥–∫–∏ 719-776)

**–î–û:**
```python
for symbol, position in current_positions.items():
    # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∏...
    
    # ‚è∞ –¢–ê–ô–ú–ï–† CHECK
    if ENABLE_TIME_STOP:
        pnl_pct = calculate_pnl_percentage(position)  # ‚ùå current_price —â–µ –Ω–µ –æ—Ç—Ä–∏–º–∞–Ω–æ!
    
    # –û—Ç—Ä–∏–º—É—î–º–æ current_price —Ç—É—Ç (–ø—ñ–∑–Ω–æ!)
    current_price = ...
    
    # PnL CHECK
    pnl_pct = calculate_pnl_percentage(position)  # ‚ùå position –Ω–µ –º–∞—î currentPrice!
```

**–ü–Ü–°–õ–Ø:**
```python
for symbol, position in current_positions.items():
    # –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ –ø–æ–∑–∏—Ü—ñ—ó —è–∫—ñ –≤–∂–µ –∑–∞–∫—Ä–∏–≤–∞—é—Ç—å—Å—è
    if position.get('status') == 'closing':
        continue
    
    # üîß –ö–†–ò–¢–ò–ß–ù–û: –°–ü–û–ß–ê–¢–ö–£ –æ—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω—É —Ü—ñ–Ω—É –¥–ª—è –í–°–Ü–• –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ PnL
    exchange = position.get('exchange', 'gate')
    entry_price = position.get('avg_entry', 0)
    
    # –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ—Ç–æ—á–Ω—É —Ü—ñ–Ω—É –∑ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó –±—ñ—Ä–∂—ñ
    current_price = None
    if exchange == "gate":
        ticker = fetch_xt_ticker(xt, symbol)
        current_price = float(ticker['last']) if ticker else None
    elif exchange == "xt" and xt:
        ticker = xt_client.fetch_xt_ticker(xt, symbol)
        current_price = float(ticker['last']) if ticker else None
        
    if not current_price or not entry_price:
        logging.warning(f"‚ö†Ô∏è [{symbol}] –ü—Ä–æ–ø—É—Å–∫–∞—î–º–æ: current_price={current_price}, entry_price={entry_price}")
        continue
    
    # üîß –ö–†–ò–¢–ò–ß–ù–û: –û–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –ø–æ—Ç–æ—á–Ω–æ—é —Ü—ñ–Ω–æ—é –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ä–æ–∑—Ä–∞—Ö—É–Ω–∫—É PnL
    position['currentPrice'] = current_price
    position['markPrice'] = current_price
    
    # ‚è∞ –¢–ê–ô–ú–ï–† CHECK
    if ENABLE_TIME_STOP:
        pnl_pct = calculate_pnl_percentage(position)  # ‚úÖ –¢–µ–ø–µ—Ä –ø—Ä–∞—Ü—é—î!
    
    # PnL CHECK
    pnl_pct = calculate_pnl_percentage(position)  # ‚úÖ –¢–µ–ø–µ—Ä –ø—Ä–∞—Ü—é—î!
```

## üß™ –¢–ï–°–¢–£–í–ê–ù–ù–Ø

–°—Ç–≤–æ—Ä–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤–∏–π —Å–∫—Ä–∏–ø—Ç `/app/test_pnl_fix.py` –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏:

**–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ç–µ—Å—Ç—É:**
```
üìä –°–ò–¢–£–ê–¶–Ü–Ø –î–û –§–Ü–ö–°–£ (currentPrice –≤—ñ–¥—Å—É—Ç–Ω—è):
‚ö†Ô∏è [AVA/USDT:USDT] P&L –Ω–µ–º–æ–∂–ª–∏–≤–æ: entry=0.3492, current=0.0
–†–µ–∑—É–ª—å—Ç–∞—Ç: PnL = +0.00%
–ü—Ä–æ–±–ª–µ–º–∞: ‚ùå PnL = 0%

üìä –°–ò–¢–£–ê–¶–Ü–Ø –ü–Ü–°–õ–Ø –§–Ü–ö–°–£ (currentPrice –¥–æ–¥–∞–Ω–æ):
‚úÖ [AVA/USDT:USDT] P&L: SHORT -21.05% (entry=$0.3492, current=$0.3597, lev=True)
–†–µ–∑—É–ª—å—Ç–∞—Ç: PnL = -21.05%
–°—Ç–∞—Ç—É—Å: ‚úÖ PnL –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Ä–æ–∑—Ä–∞—Ö–æ–≤–∞–Ω–æ!

üìà –û–ß–Ü–ö–£–í–ê–ù–ò–ô –†–û–ó–†–ê–•–£–ù–û–ö:
Entry Price: $0.3492
Current Price: $0.3597
–°—Ç–æ—Ä–æ–Ω–∞: SHORT
–ó–º—ñ–Ω–∞ —Ü—ñ–Ω–∏: -3.01%
Leverage: 7x
–û—á—ñ–∫—É–≤–∞–Ω–∏–π PnL: -21.05%

üéØ –ü–û–†–Ü–í–ù–Ø–ù–ù–Ø:
–î–æ —Ñ—ñ–∫—Å—É: +0.00%
–ü—ñ—Å–ª—è —Ñ—ñ–∫—Å—É: -21.05%
–û—á—ñ–∫—É–≤–∞–Ω–æ: -21.05%
–†—ñ–∑–Ω–∏—Ü—è: 0.00%

‚úÖ –§–Ü–ö–° –ü–†–ê–¶–Æ–Ñ –ü–†–ê–í–ò–õ–¨–ù–û! ‚úÖ
```

## üìä –í–ü–õ–ò–í –í–ò–ü–†–ê–í–õ–ï–ù–ù–Ø

**–©–æ —Ç–µ–ø–µ—Ä –ø—Ä–∞—Ü—é—î –ø—Ä–∞–≤–∏–ª—å–Ω–æ:**

1. ‚úÖ **–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ PnL** - —É –ª–æ–≥–∞—Ö —Ç–µ–ø–µ—Ä –ø–æ–∫–∞–∑—É—î—Ç—å—Å—è —Ä–µ–∞–ª—å–Ω–∏–π PnL:
   ```
   üìä [AVA/USDT:USDT] PnL CHECK: -3.02% | TP=10.0% | SL=-10.0%
   ```

2. ‚úÖ **Take Profit** - —Å–ø—Ä–∞—Ü—å–æ–≤—É—î –∫–æ–ª–∏ PnL –¥–æ—Å—è–≥–∞—î +10%

3. ‚úÖ **Stop Loss** - —Å–ø—Ä–∞—Ü—å–æ–≤—É—î –∫–æ–ª–∏ PnL –¥–æ—Å—è–≥–∞—î -10%

4. ‚úÖ **–¢–∞–π–º–µ—Ä –∑–∞–∫—Ä–∏—Ç—Ç—è** - –ø–æ–∫–∞–∑—É—î –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π PnL –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ –∑–∞ —Ç–∞–π–º–µ—Ä–æ–º

5. ‚úÖ **–ö–æ–Ω–≤–µ—Ä–≥–µ–Ω—Ü—ñ—è —Ü—ñ–Ω** - —É—Å—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—É —Ü—ñ–Ω—É

## üéØ –ß–û–ú–£ –í TELEGRAM –ü–†–ê–¶–Æ–í–ê–õ–û –ü–†–ê–í–ò–õ–¨–ù–û?

–ö–æ–º–∞–Ω–¥–∞ `/positions` –≤ Telegram –≤–∏–∫–ª–∏–∫–∞—î —Ñ—É–Ω–∫—Ü—ñ—é `get_xt_open_positions()` –∑ `xt_client.py`, —è–∫–∞:
1. –û—Ç—Ä–∏–º—É—î –ø–æ–∑–∏—Ü—ñ—ó –ë–ï–ó–ü–û–°–ï–†–ï–î–ù–¨–û –∑ API –±—ñ—Ä–∂—ñ XT.com
2. –¶—ñ –¥–∞–Ω—ñ –≤–∂–µ –º—ñ—Å—Ç—è—Ç—å `markPrice` —ñ `entryPrice`
3. –¢–æ–º—É `calculate_pnl_percentage()` –ø—Ä–∞—Ü—é–≤–∞–ª–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ

**–†—ñ–∑–Ω–∏—Ü—è:**
- **Telegram** = –¥–∞–Ω—ñ –∑ API –±—ñ—Ä–∂—ñ (—Å–≤—ñ–∂—ñ)
- **–ú–æ–Ω—ñ—Ç–æ—Ä** = –¥–∞–Ω—ñ –∑ `active_positions` (—Å—Ç–∞—Ä—ñ, –±–µ–∑ current_price) ‚ùå ‚Üí –í–ò–ü–†–ê–í–õ–ï–ù–û ‚úÖ

## üìÅ –ó–ú–Ü–ù–ï–ù–Ü –§–ê–ô–õ–ò

- `/app/bot.py` - —Ñ—É–Ω–∫—Ü—ñ—è `monitor_positions()` (—Ä—è–¥–∫–∏ 719-776)

## ‚öôÔ∏è –ó–ê–°–¢–û–°–£–í–ê–ù–ù–Ø –ó–ú–Ü–ù

–î–ª—è –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è –≤–∏–ø—Ä–∞–≤–ª–µ–Ω—å –ø–æ—Ç—Ä—ñ–±–Ω–æ:
1. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç –∞–±–æ –ø—Ä–æ—Ü–µ—Å –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É
2. –ü—ñ—Å–ª—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É PnL –±—É–¥–µ —Ä–æ–∑—Ä–∞—Ö–æ–≤—É–≤–∞—Ç–∏—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. Stop Loss —Ç–∞ Take Profit –ø–æ—á–Ω—É—Ç—å —Å–ø—Ä–∞—Ü—å–æ–≤—É–≤–∞—Ç–∏ –∫–æ—Ä–µ–∫—Ç–Ω–æ

---

**–î–∞—Ç–∞ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è:** 2025-01-14  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–ò–ü–†–ê–í–õ–ï–ù–û —Ç–∞ –ü–†–û–¢–ï–°–¢–û–í–ê–ù–û
